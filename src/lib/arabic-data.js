export const arabicTimezones = {
  arabCountries: [
    {
      country: 'السعودية',
      code: 'SA',
      priority: 1,
      cities: [
        { name: 'الرياض', timezone: 'Asia/Riyadh' },
        { name: 'جدة', timezone: 'Asia/Riyadh' },
        { name: 'مكة المكرمة', timezone: 'Asia/Riyadh' },
        { name: 'المدينة المنورة', timezone: 'Asia/Riyadh' }
      ]
    },
    {
      country: 'الإمارات',
      code: 'AE',
      priority: 2,
      cities: [
        { name: 'دبي', timezone: 'Asia/Dubai' },
        { name: 'أبوظبي', timezone: 'Asia/Dubai' },
        { name: 'الشارقة', timezone: 'Asia/Dubai' }
      ]
    },
    {
      country: 'مصر',
      code: 'EG',
      priority: 3,
      cities: [
        { name: 'القاهرة', timezone: 'Africa/Cairo' },
        { name: 'الإسكندرية', timezone: 'Africa/Cairo' },
        { name: 'الجيزة', timezone: 'Africa/Cairo' }
      ]
    },
    {
      country: 'الكويت',
      code: 'KW',
      priority: 4,
      cities: [
        { name: 'الكويت', timezone: 'Asia/Kuwait' }
      ]
    },
    {
      country: 'قطر',
      code: 'QA',
      priority: 5,
      cities: [
        { name: 'الدوحة', timezone: 'Asia/Qatar' }
      ]
    },
    {
      country: 'البحرين',
      code: 'BH',
      priority: 6,
      cities: [
        { name: 'المنامة', timezone: 'Asia/Bahrain' }
      ]
    },
    {
      country: 'عُمان',
      code: 'OM',
      priority: 7,
      cities: [
        { name: 'مسقط', timezone: 'Asia/Muscat' }
      ]
    },
    {
      country: 'الأردن',
      code: 'JO',
      priority: 8,
      cities: [
        { name: 'عمّان', timezone: 'Asia/Amman' }
      ]
    },
    {
      country: 'لبنان',
      code: 'LB',
      priority: 9,
      cities: [
        { name: 'بيروت', timezone: 'Asia/Beirut' }
      ]
    },
    {
      country: 'العراق',
      code: 'IQ',
      priority: 10,
      cities: [
        { name: 'بغداد', timezone: 'Asia/Baghdad' }
      ]
    },
    {
      country: 'سوريا',
      code: 'SY',
      priority: 11,
      cities: [
        { name: 'دمشق', timezone: 'Asia/Damascus' }
      ]
    },
    {
      country: 'فلسطين',
      code: 'PS',
      priority: 12,
      cities: [
        { name: 'القدس', timezone: 'Asia/Jerusalem' },
        { name: 'غزة', timezone: 'Asia/Gaza' }
      ]
    },
    {
      country: 'اليمن',
      code: 'YE',
      priority: 13,
      cities: [
        { name: 'صنعاء', timezone: 'Asia/Aden' }
      ]
    },
    {
      country: 'المغرب',
      code: 'MA',
      priority: 14,
      cities: [
        { name: 'الرباط', timezone: 'Africa/Casablanca' },
        { name: 'الدار البيضاء', timezone: 'Africa/Casablanca' }
      ]
    },
    {
      country: 'الجزائر',
      code: 'DZ',
      priority: 15,
      cities: [
        { name: 'الجزائر', timezone: 'Africa/Algiers' }
      ]
    },
    {
      country: 'تونس',
      code: 'TN',
      priority: 16,
      cities: [
        { name: 'تونس', timezone: 'Africa/Tunis' }
      ]
    },
    {
      country: 'ليبيا',
      code: 'LY',
      priority: 17,
      cities: [
        { name: 'طرابلس', timezone: 'Africa/Tripoli' }
      ]
    },
    {
      country: 'السودان',
      code: 'SD',
      priority: 18,
      cities: [
        { name: 'الخرطوم', timezone: 'Africa/Khartoum' }
      ]
    },
    {
      country: 'الصومال',
      code: 'SO',
      priority: 19,
      cities: [
        { name: 'مقديشو', timezone: 'Africa/Mogadishu' }
      ]
    },
    {
      country: 'جيبوتي',
      code: 'DJ',
      priority: 20,
      cities: [
        { name: 'جيبوتي', timezone: 'Africa/Djibouti' }
      ]
    },
    {
      country: 'جزر القمر',
      code: 'KM',
      priority: 21,
      cities: [
        { name: 'موروني', timezone: 'Indian/Comoro' }
      ]
    },
    {
      country: 'موريتانيا',
      code: 'MR',
      priority: 22,
      cities: [
        { name: 'نواكشوط', timezone: 'Africa/Nouakchott' }
      ]
    }
  ],

  internationalCities: [
    {
      country: 'الولايات المتحدة',
      code: 'US',
      cities: [
        { name: 'نيويورك', timezone: 'America/New_York' },
        { name: 'لوس أنجلوس', timezone: 'America/Los_Angeles' },
        { name: 'شيكاغو', timezone: 'America/Chicago' },
        { name: 'واشنطن', timezone: 'America/New_York' }
      ]
    },
    {
      country: 'المملكة المتحدة',
      code: 'GB',
      cities: [
        { name: 'لندن', timezone: 'Europe/London' }
      ]
    },
    {
      country: 'فرنسا',
      code: 'FR',
      cities: [
        { name: 'باريس', timezone: 'Europe/Paris' }
      ]
    },
    {
      country: 'ألمانيا',
      code: 'DE',
      cities: [
        { name: 'برلين', timezone: 'Europe/Berlin' }
      ]
    },
    {
      country: 'تركيا',
      code: 'TR',
      cities: [
        { name: 'إسطنبول', timezone: 'Europe/Istanbul' },
        { name: 'أنقرة', timezone: 'Europe/Istanbul' }
      ]
    },
    {
      country: 'روسيا',
      code: 'RU',
      cities: [
        { name: 'موسكو', timezone: 'Europe/Moscow' }
      ]
    },
    {
      country: 'الصين',
      code: 'CN',
      cities: [
        { name: 'بكين', timezone: 'Asia/Shanghai' },
        { name: 'شنغهاي', timezone: 'Asia/Shanghai' }
      ]
    },
    {
      country: 'اليابان',
      code: 'JP',
      cities: [
        { name: 'طوكيو', timezone: 'Asia/Tokyo' }
      ]
    },
    {
      country: 'أستراليا',
      code: 'AU',
      cities: [
        { name: 'سيدني', timezone: 'Australia/Sydney' },
        { name: 'ملبورن', timezone: 'Australia/Melbourne' }
      ]
    },
    {
      country: 'الهند',
      code: 'IN',
      cities: [
        { name: 'نيودلهي', timezone: 'Asia/Kolkata' },
        { name: 'مومباي', timezone: 'Asia/Kolkata' }
      ]
    },
    {
      country: 'باكستان',
      code: 'PK',
      cities: [
        { name: 'كراتشي', timezone: 'Asia/Karachi' }
      ]
    },
    {
      country: 'إندونيسيا',
      code: 'ID',
      cities: [
        { name: 'جاكرتا', timezone: 'Asia/Jakarta' }
      ]
    },
    {
      country: 'ماليزيا',
      code: 'MY',
      cities: [
        { name: 'كوالالمبور', timezone: 'Asia/Kuala_Lumpur' }
      ]
    },
    {
      country: 'سنغافورة',
      code: 'SG',
      cities: [
        { name: 'سنغافورة', timezone: 'Asia/Singapore' }
      ]
    }
  ]
};

export function getAllCountries() {
  return [
    ...arabicTimezones.arabCountries,
    ...arabicTimezones.internationalCities
  ].sort((a, b) => (a.priority || 999) - (b.priority || 999));
}

// Helper to format raw timezone into readable object
function formatTimezone(tz) {
  const parts = tz.split('/');
  const city = parts[parts.length - 1].replace(/_/g, ' ');
  const region = parts.length > 1 ? parts[0] : '';
  return {
    name: city,
    timezone: tz,
    country: region, // Rough approximation
    isGeneric: true
  };
}

export function searchCities(query) {
  const lowerQuery = query.toLowerCase();
  const results = [];
  const addedTimezones = new Set();

  // 1. Search Curated Arabic Data First
  const allCountries = getAllCountries();
  for (const country of allCountries) {
    const countryMatch = country.country.toLowerCase().includes(lowerQuery) || 
                         (country.englishName && country.englishName.toLowerCase().includes(lowerQuery));

    for (const city of country.cities) {
      if (countryMatch || city.name.toLowerCase().includes(lowerQuery) || city.timezone.toLowerCase().includes(lowerQuery)) {
        if (!addedTimezones.has(city.timezone)) {
          results.push({
            ...city,
            country: country.country,
            countryCode: country.code,
            isArabic: true
          });
          addedTimezones.add(city.timezone);
        }
      }
    }
  }

  // 2. Search Global Timezones
  try {
    const allTimezones = Intl.supportedValuesOf('timeZone');
    for (const tz of allTimezones) {
      // Skip if already added via Arabic data
      if (addedTimezones.has(tz)) continue;

      if (tz.toLowerCase().includes(lowerQuery)) {
        const formatted = formatTimezone(tz);
        results.push(formatted);
        addedTimezones.add(tz);
      }
      
      if (results.length >= 50) break; 
    }
  } catch (e) {
    console.error("Intl not supported or error", e);
  }

  return results;
}

export function getCitiesByCountry(countryCode) {
  const allCountries = getAllCountries();
  const country = allCountries.find(c => c.code === countryCode);
  return country ? country.cities : [];
}

export function getDefaultCities() {
  return [
    { name: 'الرياض', timezone: 'Asia/Riyadh', country: 'السعودية' },
    { name: 'دبي', timezone: 'Asia/Dubai', country: 'الإمارات' },
    { name: 'القاهرة', timezone: 'Africa/Cairo', country: 'مصر' },
    { name: 'لندن', timezone: 'Europe/London', country: 'المملكة المتحدة' }
  ];
}

export function generateSlug(timezone) {
  return timezone.toLowerCase().replace(/\//g, '-').replace(/_/g, '-');
}

export function getCityBySlug(slug) {
  // 1. Check curated list first
  const allCountries = getAllCountries();
  for (const country of allCountries) {
    for (const city of country.cities) {
      if (generateSlug(city.timezone) === slug) {
        return {
          ...city,
          country: country.country,
          countryCode: country.code
        };
      }
    }
  }

  // 2. Check global timezones
  try {
    const allTimezones = Intl.supportedValuesOf('timeZone');
    for (const tz of allTimezones) {
      if (generateSlug(tz) === slug) {
        return formatTimezone(tz);
      }
    }
  } catch (e) {
    console.error("Error finding slug in global timezones", e);
  }

  return null;
}
